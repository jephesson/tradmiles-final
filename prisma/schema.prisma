generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // Prisma 7+: NÃO coloque url aqui se você usa prisma.config.ts
}

enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PixTipo {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

/**
 * =========================
 * BLOQUEIOS
 * =========================
 */
enum LoyaltyProgram {
  LATAM
  SMILES
  LIVELO
  ESFERA
}

enum BlockStatus {
  OPEN
  UNBLOCKED
  CANCELED
}

model User {
  id    String @id @default(uuid())
  login String @unique
  name  String

  employeeId String? @unique

  cpf          String? @unique
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cedentes em que o usuário é o "responsável" (owner)
  cedentesOwned Cedente[] @relation("CedenteOwner")

  // Cedentes que ele revisou (aprovou/reprovou)
  cedentesReviewed Cedente[] @relation("CedenteReviewedBy")

  // ✅ Dívidas criadas por este usuário (lado oposto de Debt.createdBy)
  debtsCreated Debt[]

  // ✅ Bloqueios criados por este usuário (lado oposto de BlockedAccount.createdBy)
  blockedCreated BlockedAccount[] @relation("BlockedCreatedBy")

  // ✅ Observações de bloqueio criadas por este usuário (lado oposto de BlockObservation.createdBy)
  blockedObsCreated BlockObservation[] @relation("BlockedObsCreatedBy")

  // Um convite por usuário (no teu fluxo)
  employeeInvite EmployeeInvite?

  @@index([team])
  @@index([role])
  @@map("users")
}

model EmployeeInvite {
  id     String @id @default(uuid())
  userId String @unique
  code   String @unique

  isActive   Boolean   @default(true)
  uses       Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cedentes Cedente[]

  @@index([isActive])
  @@index([userId])
  @@map("employee_invites")
}

model Cedente {
  id            String @id @default(uuid())
  identificador String @unique

  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String    @unique

  telefone    String?
  emailCriado String?

  banco             String
  pixTipo           PixTipo
  chavePix          String
  titularConfirmado Boolean @default(true)

  senhaEmail     String?
  senhaSmiles    String?
  senhaLatamPass String?
  senhaLivelo    String?
  senhaEsfera    String?

  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  status     CedenteStatus @default(PENDING)
  reviewedAt DateTime?

  reviewedById String?
  reviewedBy   User?   @relation("CedenteReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  ownerId String
  owner   User   @relation("CedenteOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  inviteId String?
  invite   EmployeeInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  termAcceptances CedenteTermAcceptance[]

  // ✅ Bloqueios vinculados a este cedente
  blockedAccounts BlockedAccount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([inviteId])
  @@index([createdAt])
  @@map("cedentes")
}

model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([cedenteId])
  @@index([acceptedAt])
  @@map("cedente_term_acceptances")
}

model CashSnapshot {
  id           String   @id @default(cuid())
  date         DateTime @unique

  totalBruto   Int      // em centavos
  totalDividas Int      // em centavos
  totalLiquido Int      // em centavos

  createdAt DateTime @default(now())

  @@map("cash_snapshots")
}

model Settings {
  id  String @id @default(cuid())
  key String @unique

  latamRateCents  Int @default(2000) // R$20,00 por milheiro
  smilesRateCents Int @default(1800)
  liveloRateCents Int @default(2200)
  esferaRateCents Int @default(1700)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DebtStatus {
  OPEN
  PAID
  CANCELED
}

model Debt {
  id          String     @id @default(cuid())
  title       String // descrição curta (ex: "Cartão Nubank", "123milhas", etc.)
  description String? // opcional (detalhes)
  totalCents  Int // valor total da dívida em centavos
  status      DebtStatus @default(OPEN)

  // quem criou (opcional, mas útil)
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  payments DebtPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("debts")
}

model DebtPayment {
  id          String   @id @default(cuid())
  debtId      String
  amountCents Int // pagamento em centavos
  note        String? // opcional (ex: "pix", "boleto", "parcial", etc.)
  paidAt      DateTime @default(now()) // data/hora do pagamento (auto)

  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([debtId])
  @@index([paidAt])
  @@map("debt_payments")
}

/**
 * =========================
 * MODELS BLOQUEIOS
 * =========================
 */
model BlockedAccount {
  id String @id @default(cuid())

  cedenteId String
  program   LoyaltyProgram
  status    BlockStatus    @default(OPEN)

  note              String?
  estimatedUnlockAt DateTime? // previsão de desbloqueio

  createdById String?
  createdBy   User?   @relation("BlockedCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  resolvedAt DateTime?

  observations BlockObservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  // impede duplicar mais de 1 bloqueio OPEN do mesmo programa no mesmo cedente
  @@unique([cedenteId, program, status], map: "uniq_open_block_per_program")
  @@index([cedenteId])
  @@index([program])
  @@index([status])
  @@index([createdAt])
  @@map("blocked_accounts")
}

model BlockObservation {
  id        String @id @default(cuid())
  blockedId String
  text      String

  createdById String?
  createdBy   User?   @relation("BlockedObsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blocked BlockedAccount @relation(fields: [blockedId], references: [id], onDelete: Cascade)

  @@index([blockedId])
  @@index([createdAt])
  @@map("block_observations")
}


