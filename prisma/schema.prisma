generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // Prisma 7+: NÃO coloque url aqui se você usa prisma.config.ts
}

/**
 * =========================
 * ENUMS BÁSICOS
 * =========================
 */
enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PixTipo {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

enum SalePaymentStatus {
  PENDING
  PAID
  CANCELED
}

/**
 * =========================
 * BLOQUEIOS / PROGRAMAS
 * =========================
 */
enum LoyaltyProgram {
  LATAM
  SMILES
  LIVELO
  ESFERA
}

enum BlockStatus {
  OPEN
  UNBLOCKED
  CANCELED
}

enum CedenteCommissionStatus {
  PENDING
  PAID
  CANCELED
}

/**
 * =========================
 * USERS / LOGIN / CONVITES
 * =========================
 */
model User {
  id    String @id @default(uuid())
  login String @unique
  name  String

  employeeId String? @unique

  cpf          String? @unique
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cedentes em que o usuário é o "responsável" (owner)
  cedentesOwned Cedente[] @relation("CedenteOwner")

  // Cedentes que ele revisou (aprovou/reprovou)
  cedentesReviewed Cedente[] @relation("CedenteReviewedBy")

  // Dívidas criadas por este usuário
  debtsCreated Debt[]

  // Bloqueios criados por este usuário
  blockedCreated BlockedAccount[] @relation("BlockedCreatedBy")

  // Observações de bloqueio criadas por este usuário
  blockedObsCreated BlockObservation[] @relation("BlockedObsCreatedBy")

  // Compras liberadas por este usuário
  comprasLiberadas Purchase[] @relation("CompraLiberadaPor")

  // Compras finalizadas por este usuário
  comprasFinalizadas Purchase[] @relation("PurchaseFinalizedBy")

  // Comissões de cedente (geradas / pagas)
  cedenteCommissionsGenerated CedenteCommission[] @relation("CedenteCommissionGeneratedBy")
  cedenteCommissionsPaid      CedenteCommission[] @relation("CedenteCommissionPaidBy")

  // Clientes criados por este usuário
  clientesCreated Cliente[] @relation("ClienteCreatedBy")

  // Vendas feitas por este usuário
  salesSold Sale[] @relation("SaleSeller")

  /**
   * =========================
   * RATEIO (BASE PERCENTUAL)
   * =========================
   */
  profitSharesOwned  ProfitShare[]     @relation("ProfitShareOwner")
  profitShareAsPayee ProfitShareItem[] @relation("ProfitSharePayee")

  /**
   * =========================
   * PAGAMENTOS (COMISSÕES FUNCIONÁRIOS POR DIA)
   * =========================
   * - marca o "pago" por DIA REFERENTE (dia fechado)
   * - permite pagar 2-3 dias depois sem perder o histórico
   */
  employeePayouts     EmployeePayout[] @relation("EmployeePayoutUser")
  employeePayoutsPaid EmployeePayout[] @relation("EmployeePayoutPaidBy")

  // Um convite por usuário
  employeeInvite EmployeeInvite?

  @@index([team])
  @@index([role])
  @@map("users")
}

model EmployeeInvite {
  id     String @id @default(uuid())
  userId String @unique
  code   String @unique

  isActive   Boolean   @default(true)
  uses       Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cedentes Cedente[]

  @@index([isActive])
  @@index([userId])
  @@map("employee_invites")
}

/**
 * =========================
 * RATEIO (BASE PERCENTUAL) — VERSIONADO POR DATA
 * =========================
 * Regras:
 * - Para cada "owner" (funcionário dono dos cedentes), pode existir múltiplas versões
 * - A versão é definida por effectiveFrom (vigência a partir de)
 * - effectiveTo (opcional) fecha a vigência quando uma nova versão entra
 * - Os itens somam 100% (10000 bps)
 * ✅ IMPORTANTE (não perder dados):
 * - effectiveFrom é NOT NULL com DEFAULT '2000-01-01', então qualquer rateio antigo passa
 * a valer desde sempre (não quebra cálculos históricos).
 */
model ProfitShare {
  id      String @id @default(cuid())
  team    String
  ownerId String

  // ✅ vigência
  effectiveFrom DateTime  @default(dbgenerated("'2000-01-01 00:00:00'::timestamp"))
  effectiveTo   DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User              @relation("ProfitShareOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  items ProfitShareItem[]

  // ✅ agora é versionado (não é mais 1 por owner)
  @@unique([team, ownerId, effectiveFrom], map: "uniq_profitshare_owner_from")
  @@index([team])
  @@index([ownerId])
  @@index([team, ownerId, effectiveFrom])
  @@index([team, ownerId, effectiveTo])
  @@map("profit_shares")
}

model ProfitShareItem {
  id      String @id @default(cuid())
  shareId String
  payeeId String

  // Basis points (10000 = 100.00%)
  bps Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  share ProfitShare @relation(fields: [shareId], references: [id], onDelete: Cascade)
  payee User        @relation("ProfitSharePayee", fields: [payeeId], references: [id], onDelete: Cascade)

  @@unique([shareId, payeeId])
  @@index([payeeId])
  @@map("profit_share_items")
}

/**
 * =========================
 * CEDENTES
 * =========================
 */
model Cedente {
  id            String @id @default(uuid())
  identificador String @unique

  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String    @unique

  telefone    String?
  emailCriado String?

  banco             String
  pixTipo           PixTipo
  chavePix          String
  titularConfirmado Boolean @default(true)

  senhaEmail     String?
  senhaSmiles    String?
  senhaLatamPass String?
  senhaLivelo    String?
  senhaEsfera    String?

  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  status     CedenteStatus @default(PENDING)
  reviewedAt DateTime?

  reviewedById String?
  reviewedBy   User?   @relation("CedenteReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  ownerId String
  owner   User   @relation("CedenteOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  inviteId String?
  invite   EmployeeInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  termAcceptances CedenteTermAcceptance[]

  // Bloqueios vinculados a este cedente
  blockedAccounts BlockedAccount[]

  // Compras vinculadas a este cedente
  purchases Purchase[]

  // Comissões do cedente
  cedenteCommissions CedenteCommission[]

  // Contagem CPF / emissões
  emissions EmissionEvent[]

  // Vendas vinculadas a este cedente
  sales Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([inviteId])
  @@index([createdAt])
  @@map("cedentes")
}

model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([cedenteId])
  @@index([acceptedAt])
  @@map("cedente_term_acceptances")
}

/**
 * =========================
 * SNAPSHOT (CAIXA + TOTAIS)
 * =========================
 */
model CashSnapshot {
  id   String   @id @default(cuid())
  date DateTime @unique

  cashCents Int @default(0) // caixa (Inter) em centavos

  totalBruto   Int
  totalDividas Int
  totalLiquido Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@map("cash_snapshots")
}

model Settings {
  id  String @id @default(cuid())
  key String @unique

  latamRateCents  Int @default(2000)
  smilesRateCents Int @default(1800)
  liveloRateCents Int @default(2200)
  esferaRateCents Int @default(1700)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings") // ✅ FIX: tabela real (lowercase)
}

/**
 * =========================
 * DÍVIDAS
 * =========================
 */
enum DebtStatus {
  OPEN
  PAID
  CANCELED
}

model Debt {
  id          String     @id @default(cuid())
  title       String
  description String?
  totalCents  Int
  status      DebtStatus @default(OPEN)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  payments DebtPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("debts")
}

model DebtPayment {
  id          String   @id @default(cuid())
  debtId      String
  amountCents Int
  note        String?
  paidAt      DateTime @default(now())

  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([debtId])
  @@index([paidAt])
  @@map("debt_payments")
}

/**
 * =========================
 * BLOQUEIOS
 * =========================
 */
model BlockedAccount {
  id String @id @default(cuid())

  cedenteId String
  program   LoyaltyProgram
  status    BlockStatus    @default(OPEN)

  note              String?
  estimatedUnlockAt DateTime?

  createdById String?
  createdBy   User?   @relation("BlockedCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  resolvedAt   DateTime?
  observations BlockObservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@unique([cedenteId, program, status], map: "uniq_open_block_per_program")
  @@index([cedenteId])
  @@index([program])
  @@index([status])
  @@index([createdAt])
  @@map("blocked_accounts")
}

model BlockObservation {
  id        String @id @default(cuid())
  blockedId String
  text      String

  createdById String?
  createdBy   User?   @relation("BlockedObsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blocked BlockedAccount @relation(fields: [blockedId], references: [id], onDelete: Cascade)

  @@index([blockedId])
  @@index([createdAt])
  @@map("block_observations")
}

/**
 * =========================
 * COMPRAS
 * =========================
 */
enum PurchaseStatus {
  OPEN
  CLOSED
  CANCELED
}

enum PurchaseItemType {
  CLUB
  POINTS_BUY
  TRANSFER
  ADJUSTMENT
  EXTRA_COST
}

enum PurchaseItemStatus {
  PENDING
  RELEASED
  CANCELED
}

enum TransferMode {
  FULL_POINTS
  POINTS_PLUS_CASH
}

model Purchase {
  id        String         @id @default(cuid())
  numero    String         @unique // ID00001
  cedenteId String
  status    PurchaseStatus @default(OPEN)

  /**
   * =========================
   * DEFINIÇÃO DA VENDA
   * =========================
   */
  ciaAerea       LoyaltyProgram?
  pontosCiaTotal Int             @default(0)

  /**
   * =========================
   * CUSTOS
   * =========================
   */
  cedentePayCents     Int @default(0)
  vendorCommissionBps Int @default(100)

  subtotalCents Int @default(0)
  comissaoCents Int @default(0)
  totalCents    Int @default(0)

  /**
   * =========================
   * MILHEIRO / META
   * =========================
   */
  custoMilheiroCents Int @default(0)
  metaMarkupCents    Int @default(150)
  metaMilheiroCents  Int @default(0)

  /**
   * =========================
   * SALDO PREVISTO (ANTES DE LIBERAR)
   * =========================
   */
  saldoPrevistoLatam  Int?
  saldoPrevistoSmiles Int?
  saldoPrevistoLivelo Int?
  saldoPrevistoEsfera Int?

  /**
   * =========================
   * SALDO APLICADO (APÓS LIBERAÇÃO)
   * =========================
   */
  saldoAplicadoLatam  Int?
  saldoAplicadoSmiles Int?
  saldoAplicadoLivelo Int?
  saldoAplicadoEsfera Int?

  /**
   * =========================
   * CONTROLE DE LIBERAÇÃO
   * =========================
   */
  liberadoEm    DateTime?
  liberadoPorId String?
  liberadoPor   User?     @relation("CompraLiberadaPor", fields: [liberadoPorId], references: [id], onDelete: SetNull)

  /**
   * =========================
   * FINALIZAÇÃO (RATEIO/LUCRO)
   * =========================
   */
  finalizedAt   DateTime?
  finalizedById String?
  finalizedBy   User?     @relation("PurchaseFinalizedBy", fields: [finalizedById], references: [id], onDelete: SetNull)

  /**
   * ✅ SNAPSHOTS CONSOLIDADOS DO ID NO MOMENTO DA FINALIZAÇÃO
   */
  finalSalesCents            Int?
  finalSalesPointsValueCents Int?
  finalSalesTaxesCents       Int?

  finalProfitBrutoCents Int?
  finalBonusCents       Int?
  finalProfitCents      Int?

  finalSoldPoints       Int?
  finalPax              Int?
  finalAvgMilheiroCents Int?

  // opcional: útil pra auditoria/relatórios
  finalRemainingPoints Int?

  /**
   * =========================
   * OBSERVAÇÃO
   * =========================
   */
  observacao String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente        @relation(fields: [cedenteId], references: [id], onDelete: Cascade)
  items   PurchaseItem[]

  // Vendas vinculadas a esta compra
  sales Sale[]

  // lado inverso 1:1 com CedenteCommission
  cedenteCommission CedenteCommission? @relation("PurchaseCedenteCommission")

  @@index([cedenteId])
  @@index([status])
  @@index([ciaAerea])
  @@index([finalizedAt])
  @@index([finalizedById])
  @@map("purchases")
}

model PurchaseItem {
  id         String             @id @default(cuid())
  purchaseId String
  type       PurchaseItemType
  status     PurchaseItemStatus @default(PENDING)

  programFrom LoyaltyProgram?
  programTo   LoyaltyProgram?

  // pontos
  pointsBase  Int     @default(0)
  bonusMode   String?
  bonusValue  Int?
  pointsFinal Int     @default(0)

  // dinheiro
  amountCents  Int           @default(0)
  transferMode TransferMode?

  pointsDebitedFromOrigin Int @default(0)

  title   String
  details String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([type])
  @@index([status])
  @@map("purchase_items")
}

model Counter {
  key   String @id
  value Int    @default(0)

  updatedAt DateTime @updatedAt

  @@map("counters")
}

/**
 * =========================
 * COMISSÃO DO CEDENTE
 * =========================
 */
model CedenteCommission {
  id String @id @default(cuid())

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  // 1:1 opcional com Purchase
  purchaseId String?   @unique
  purchase   Purchase? @relation("PurchaseCedenteCommission", fields: [purchaseId], references: [id], onDelete: SetNull)

  amountCents Int
  status      CedenteCommissionStatus @default(PENDING)

  generatedAt   DateTime @default(now())
  generatedById String?
  generatedBy   User?    @relation("CedenteCommissionGeneratedBy", fields: [generatedById], references: [id], onDelete: SetNull)

  paidAt   DateTime?
  paidById String?
  paidBy   User?     @relation("CedenteCommissionPaidBy", fields: [paidById], references: [id], onDelete: SetNull)

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cedenteId, status, generatedAt])
  @@index([paidAt])
  @@map("cedente_commissions")
}

/**
 * =========================
 * CLIENTES
 * =========================
 */
enum ClienteTipo {
  PESSOA
  EMPRESA
}

enum ClienteOrigem {
  BALCAO_MILHAS
  PARTICULAR
  SITE
  OUTROS
}

model Cliente {
  id            String @id @default(cuid())
  identificador String @unique // CL00001

  tipo ClienteTipo @default(PESSOA)
  nome String

  cpfCnpj  String?
  telefone String?

  origem          ClienteOrigem
  origemDescricao String?

  createdById String?
  createdBy   User?   @relation("ClienteCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  // Vendas vinculadas a este cliente
  sales Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([origem])
  @@index([createdAt])
  @@map("clientes")
}

/**
 * =========================
 * RECEBÍVEIS (CONTAS A RECEBER)
 * =========================
 */
enum ReceivableStatus {
  OPEN
  RECEIVED
  CANCELED
}

model Receivable {
  id            String           @id @default(cuid())
  title         String
  description   String?
  totalCents    Int
  receivedCents Int              @default(0)
  balanceCents  Int
  status        ReceivableStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  receipts Receipt[]

  // lado inverso do Sale.receivable (FK está em Sale.receivableId)
  sale Sale? @relation("SaleReceivable")

  @@index([status])
  @@index([createdAt])
  @@map("receivables") // ✅ FIX: tabela real (lowercase)
}

model Receipt {
  id           String     @id @default(cuid())
  receivableId String
  receivable   Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  amountCents Int
  note        String?
  receivedAt  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([receivableId])
  @@index([receivedAt])
  @@map("Receipt") // ⚠️ se sua tabela for lowercase, troque pra "receipts"
}

/**
 * =========================
 * CONTAGEM CPF (EMISSÕES)
 * =========================
 */
enum EmissionSource {
  SALE
  MANUAL
  ADJUSTMENT
}

model EmissionEvent {
  id String @id @default(cuid())

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  program         LoyaltyProgram
  passengersCount Int            @default(1)

  issuedAt DateTime
  source   EmissionSource @default(SALE)

  note String?

  createdAt DateTime @default(now())

  @@index([cedenteId, program, issuedAt])
  @@index([program, issuedAt])
  @@map("emission_events")
}

/**
 * =========================
 * VENDAS
 * =========================
 */
model Sale {
  id     String @id @default(cuid())
  numero String @unique // VE00001

  date DateTime

  program    LoyaltyProgram
  points     Int
  passengers Int

  // centavos por 1000 pontos (SEM taxa)
  milheiroCents Int

  // taxas (ex.: embarque) separadas
  embarqueFeeCents Int @default(0)

  // somente milhas (SEM taxa)
  pointsValueCents Int @default(0)

  // total cobrado (milhas + taxas)
  totalCents Int @default(0)

  // comissão / bônus
  commissionCents Int @default(0)

  // bônus pago (ex.: 30% excedente acima da meta)
  bonusCents Int @default(0)

  // meta usada no momento da venda (pra auditabilidade)
  metaMilheiroCents Int @default(0)

  feeCardLabel String?
  locator      String?

  paymentStatus SalePaymentStatus @default(PENDING)
  paidAt        DateTime?

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Restrict)

  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Restrict)

  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id], onDelete: SetNull)

  sellerId String?
  seller   User?   @relation("SaleSeller", fields: [sellerId], references: [id], onDelete: SetNull)

  receivableId String?     @unique
  receivable   Receivable? @relation("SaleReceivable", fields: [receivableId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([program, date])
  @@index([paymentStatus])
  @@index([cedenteId])
  @@index([clienteId])
  @@index([purchaseId])
  @@map("sales")
}

/**
 * =========================
 * PAGAMENTOS (COMISSÕES FUNCIONÁRIOS POR DIA)
 * =========================
 * Guarda o pagamento por "dia fechado" (date) e funcionário.
 * Permite pagar dias passados (ficar pendente até quitar), e manter histórico completo.
 */
model EmployeePayout {
  id String @id @default(cuid())

  /**
   * ✅ Dia referente ao lucro (dia fechado)
   * Recomendação: salvar como 00:00 no fuso do Brasil (-03).
   */
  date   DateTime
  userId String

  // lucro (1% + 30% + rateio) do dia
  grossProfitCents Int

  // 7% só em cima do lucro (grossProfit)
  tax7Cents Int

  // reembolso das taxas (embarque) pagas no cartão do funcionário
  feeCents Int

  // total líquido a pagar (gross - tax + fee)
  netPayCents Int

  // detalhamento livre (comissão1/bonus30/rateio etc.)
  breakdown Json?

  // quando pagou de fato
  paidAt   DateTime @default(now())
  paidById String?

  user   User  @relation("EmployeePayoutUser", fields: [userId], references: [id], onDelete: Cascade)
  paidBy User? @relation("EmployeePayoutPaidBy", fields: [paidById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, userId], map: "uniq_employee_payout_day_user")
  @@index([date])
  @@index([userId, date])
  @@map("employee_payouts")
}
