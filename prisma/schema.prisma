// prisma/schema.prisma

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PixTipo {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

model User {
  id           String  @id @default(uuid())
  login        String  @unique
  name         String

  cpf          String? @unique
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // quem aprovou/reprovou
  cedentesAprovados Cedente[] @relation("CedenteApprovedBy")

  // cedentes que pertencem ao funcionário (rateio / owner)
  cedentesOwned Cedente[] @relation("CedenteOwner")

  // convite único por funcionário
  employeeInvite EmployeeInvite?
}

model Cedente {
  id             String    @id @default(uuid())
  identificador  String    @unique
  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String    @unique

  // ✅ contato / acesso
  telefone    String? // DDD + número (em dígitos)
  emailCriado String?

  // ✅ pagamento (PIX)
  banco              String?
  pixTipo            PixTipo?
  chavePix           String?
  titularConfirmado  Boolean  @default(false)

  // ✅ senhas (texto por enquanto)
  senhaEmailEnc     String?
  senhaSmilesEnc    String?
  senhaLatamPassEnc String?
  senhaLiveloEnc    String?
  senhaEsferaEnc    String?

  // pontos
  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  // status / auditoria de revisão
  status       CedenteStatus @default(PENDING)
  reviewedAt   DateTime?
  reviewedById String?
  reviewedBy   User?         @relation("CedenteApprovedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  // ✅ dono do cedente (funcionário do convite)
  ownerId String
  owner   User   @relation("CedenteOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  // termo(s)
  termAcceptances CedenteTermAcceptance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@map("cedentes")
}

model EmployeeInvite {
  id       String  @id @default(uuid())
  userId   String  @unique
  code     String  @unique
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("employee_invites")
}

model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([cedenteId])
  @@map("cedente_term_acceptances")
}
