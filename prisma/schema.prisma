generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // Prisma 7+: NÃO coloque url aqui se você usa prisma.config.ts
}

enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PixTipo {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

/**
 * =========================
 * BLOQUEIOS / PROGRAMAS
 * =========================
 */
enum LoyaltyProgram {
  LATAM
  SMILES
  LIVELO
  ESFERA
}

enum BlockStatus {
  OPEN
  UNBLOCKED
  CANCELED
}

enum CedenteCommissionStatus {
  PENDING
  PAID
  CANCELED
}

model User {
  id    String @id @default(uuid())
  login String @unique
  name  String

  employeeId String? @unique

  cpf          String? @unique
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cedentes em que o usuário é o "responsável" (owner)
  cedentesOwned Cedente[] @relation("CedenteOwner")

  // Cedentes que ele revisou (aprovou/reprovou)
  cedentesReviewed Cedente[] @relation("CedenteReviewedBy")

  // ✅ Dívidas criadas por este usuário (lado oposto de Debt.createdBy)
  debtsCreated Debt[]

  // ✅ Bloqueios criados por este usuário (lado oposto de BlockedAccount.createdBy)
  blockedCreated BlockedAccount[] @relation("BlockedCreatedBy")

  // ✅ Observações de bloqueio criadas por este usuário (lado oposto de BlockObservation.createdBy)
  blockedObsCreated BlockObservation[] @relation("BlockedObsCreatedBy")

  // ✅ Compras liberadas por este usuário (lado inverso de Purchase.liberadoPor)
  comprasLiberadas Purchase[] @relation("CompraLiberadaPor")

  // ✅ Comissões de cedente (geradas / pagas)
  cedenteCommissionsGenerated CedenteCommission[] @relation("CedenteCommissionGeneratedBy")
  cedenteCommissionsPaid      CedenteCommission[] @relation("CedenteCommissionPaidBy")

  // ✅ CLIENTES criados por este usuário (lado inverso de Cliente.createdBy)
  clientesCreated Cliente[] @relation("ClienteCreatedBy")

  // Um convite por usuário (no teu fluxo)
  employeeInvite EmployeeInvite?

  @@index([team])
  @@index([role])
  @@map("users")
}

model EmployeeInvite {
  id     String @id @default(uuid())
  userId String @unique
  code   String @unique

  isActive   Boolean   @default(true)
  uses       Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cedentes Cedente[]

  @@index([isActive])
  @@index([userId])
  @@map("employee_invites")
}

model Cedente {
  id            String @id @default(uuid())
  identificador String @unique

  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String    @unique

  telefone    String?
  emailCriado String?

  banco             String
  pixTipo           PixTipo
  chavePix          String
  titularConfirmado Boolean @default(true)

  senhaEmail     String?
  senhaSmiles    String?
  senhaLatamPass String?
  senhaLivelo    String?
  senhaEsfera    String?

  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  status     CedenteStatus @default(PENDING)
  reviewedAt DateTime?

  reviewedById String?
  reviewedBy   User?   @relation("CedenteReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  ownerId String
  owner   User   @relation("CedenteOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  inviteId String?
  invite   EmployeeInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  termAcceptances CedenteTermAcceptance[]

  // ✅ Bloqueios vinculados a este cedente
  blockedAccounts BlockedAccount[]

  // ✅ Compras vinculadas a este cedente
  purchases Purchase[]

  // ✅ Comissões do cedente
  cedenteCommissions CedenteCommission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([inviteId])
  @@index([createdAt])
  @@map("cedentes")
}

model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([cedenteId])
  @@index([acceptedAt])
  @@map("cedente_term_acceptances")
}

/**
 * =========================
 * SNAPSHOT (CAIXA + TOTAIS)
 * =========================
 */
model CashSnapshot {
  id   String   @id @default(cuid())
  date DateTime @unique

  cashCents Int @default(0) // ✅ caixa (Inter) em centavos

  totalBruto   Int // em centavos
  totalDividas Int // em centavos
  totalLiquido Int // em centavos

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@map("cash_snapshots")
}

model Settings {
  id  String @id @default(cuid())
  key String @unique

  latamRateCents  Int @default(2000) // R$20,00 por milheiro
  smilesRateCents Int @default(1800)
  liveloRateCents Int @default(2200)
  esferaRateCents Int @default(1700)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DebtStatus {
  OPEN
  PAID
  CANCELED
}

model Debt {
  id          String     @id @default(cuid())
  title       String
  description String?
  totalCents  Int
  status      DebtStatus @default(OPEN)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  payments DebtPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("debts")
}

model DebtPayment {
  id          String   @id @default(cuid())
  debtId      String
  amountCents Int
  note        String?
  paidAt      DateTime @default(now())

  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([debtId])
  @@index([paidAt])
  @@map("debt_payments")
}

/**
 * =========================
 * MODELS BLOQUEIOS
 * =========================
 */
model BlockedAccount {
  id String @id @default(cuid())

  cedenteId String
  program   LoyaltyProgram
  status    BlockStatus    @default(OPEN)

  note              String?
  estimatedUnlockAt DateTime?

  createdById String?
  createdBy   User?   @relation("BlockedCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  resolvedAt   DateTime?
  observations BlockObservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@unique([cedenteId, program, status], map: "uniq_open_block_per_program")
  @@index([cedenteId])
  @@index([program])
  @@index([status])
  @@index([createdAt])
  @@map("blocked_accounts")
}

model BlockObservation {
  id        String @id @default(cuid())
  blockedId String
  text      String

  createdById String?
  createdBy   User?   @relation("BlockedObsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blocked BlockedAccount @relation(fields: [blockedId], references: [id], onDelete: Cascade)

  @@index([blockedId])
  @@index([createdAt])
  @@map("block_observations")
}

/**
 * =========================
 * COMPRAS (NOVA COMPLETA)
 * =========================
 */
enum PurchaseStatus {
  OPEN
  CLOSED
  CANCELED
}

enum PurchaseItemType {
  CLUB
  POINTS_BUY
  TRANSFER
  ADJUSTMENT
  EXTRA_COST
}

enum PurchaseItemStatus {
  PENDING
  RELEASED
  CANCELED
}

enum TransferMode {
  FULL_POINTS
  POINTS_PLUS_CASH
}

model Purchase {
  id        String         @id @default(cuid())
  numero    String         @unique // ID00001
  cedenteId String
  status    PurchaseStatus @default(OPEN)

  /**
   * =========================
   * DEFINIÇÃO DA VENDA
   * =========================
   */
  ciaAerea       LoyaltyProgram?
  pontosCiaTotal Int             @default(0)

  /**
   * =========================
   * CUSTOS
   * =========================
   */
  cedentePayCents     Int @default(0)
  vendorCommissionBps Int @default(100)

  subtotalCents Int @default(0)
  comissaoCents Int @default(0)
  totalCents    Int @default(0)

  /**
   * =========================
   * MILHEIRO / META
   * =========================
   */
  custoMilheiroCents Int @default(0)
  metaMarkupCents    Int @default(150)
  metaMilheiroCents  Int @default(0)

  /**
   * =========================
   * SALDO PREVISTO (ANTES DE LIBERAR)
   * =========================
   */
  saldoPrevistoLatam  Int?
  saldoPrevistoSmiles Int?
  saldoPrevistoLivelo Int?
  saldoPrevistoEsfera Int?

  /**
   * =========================
   * SALDO APLICADO (APÓS LIBERAÇÃO)
   * =========================
   */
  saldoAplicadoLatam  Int?
  saldoAplicadoSmiles Int?
  saldoAplicadoLivelo Int?
  saldoAplicadoEsfera Int?

  /**
   * =========================
   * CONTROLE DE LIBERAÇÃO
   * =========================
   */
  liberadoEm    DateTime?
  liberadoPorId String?
  liberadoPor   User?     @relation("CompraLiberadaPor", fields: [liberadoPorId], references: [id], onDelete: SetNull)

  /**
   * =========================
   * OBSERVAÇÃO
   * =========================
   */
  observacao String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente        @relation(fields: [cedenteId], references: [id], onDelete: Cascade)
  items   PurchaseItem[]

  // ✅ AJUSTE: lado inverso 1:1 com CedenteCommission
  cedenteCommission CedenteCommission? @relation("PurchaseCedenteCommission")

  @@index([cedenteId])
  @@index([status])
  @@index([ciaAerea])
  @@map("purchases")
}

model PurchaseItem {
  id         String             @id @default(cuid())
  purchaseId String
  type       PurchaseItemType
  status     PurchaseItemStatus @default(PENDING)

  programFrom LoyaltyProgram?
  programTo   LoyaltyProgram?

  // pontos
  pointsBase  Int     @default(0)
  bonusMode   String?
  bonusValue  Int?
  pointsFinal Int     @default(0)

  // dinheiro
  amountCents  Int           @default(0)
  transferMode TransferMode?

  pointsDebitedFromOrigin Int @default(0)

  title   String
  details String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([type])
  @@index([status])
  @@map("purchase_items")
}

model Counter {
  key   String @id
  value Int    @default(0)

  updatedAt DateTime @updatedAt

  @@map("counters")
}

model CedenteCommission {
  id String @id @default(cuid())

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  // 1:1 opcional com Purchase (um Purchase pode gerar no máximo 1 comissão)
  purchaseId String?   @unique
  purchase   Purchase? @relation("PurchaseCedenteCommission", fields: [purchaseId], references: [id], onDelete: SetNull)

  amountCents Int
  status      CedenteCommissionStatus @default(PENDING)

  generatedAt   DateTime @default(now())
  generatedById String?
  generatedBy   User?    @relation("CedenteCommissionGeneratedBy", fields: [generatedById], references: [id], onDelete: SetNull)

  paidAt   DateTime?
  paidById String?
  paidBy   User?     @relation("CedenteCommissionPaidBy", fields: [paidById], references: [id], onDelete: SetNull)

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cedenteId, status, generatedAt])
  @@index([paidAt])
  @@map("cedente_commissions")
}

enum ClienteTipo {
  PESSOA
  EMPRESA
}

enum ClienteOrigem {
  BALCAO_MILHAS
  PARTICULAR
  SITE
  OUTROS
}

model Cliente {
  id            String @id @default(cuid())
  identificador String @unique // CL00001

  tipo ClienteTipo @default(PESSOA)
  nome String

  cpfCnpj  String?
  telefone String?

  origem          ClienteOrigem
  origemDescricao String?

  createdById String?
  createdBy   User?   @relation("ClienteCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([origem])
  @@index([createdAt])
  @@map("clientes")
}
