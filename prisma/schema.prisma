generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * STATUS DO CEDENTE
 */
enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

/**
 * MODELOS
 */
model User {
  id           String  @id @default(uuid())
  login        String  @unique
  name         String
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quem aprovou/reprovou cedentes
  cedentesAprovados Cedente[] @relation("CedenteApprovedBy")
}

/**
 * CEDENTE
 */
model Cedente {
  id             String    @id @default(uuid())
  identificador  String    @unique
  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String    @unique

  emailCriado String?
  chavePix    String?
  banco       String?

  // credenciais (como você pediu, sem criptografia por enquanto)
  senhaEmailEnc     String?
  senhaSmilesEnc    String?
  senhaLatamPassEnc String?
  senhaLiveloEnc    String?
  senhaEsferaEnc    String?

  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  // status / revisão
  status       CedenteStatus @default(PENDING)
  reviewedAt   DateTime?
  reviewedById String?
  reviewedBy   User? @relation(
    "CedenteApprovedBy",
    fields: [reviewedById],
    references: [id],
    onDelete: SetNull
  )

  // relações
  termAcceptances CedenteTermAcceptance[]
  invite          CedenteInvite?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("cedentes")
}

/**
 * CONVITE DO CEDENTE
 * ✅ token direto (SEM HASH)
 */
model CedenteInvite {
  id        String   @id @default(uuid())

  // ✅ token público usado na URL /convite/[token]
  token     String   @unique

  createdBy String?
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  // hints para pré-preenchimento
  nomeHint String?
  cpfHint  String?

  // vínculo com cedente criado
  cedenteId String?  @unique
  cedente   Cedente? @relation(
    fields: [cedenteId],
    references: [id],
    onDelete: SetNull
  )

  @@index([expiresAt])
  @@index([usedAt])
  @@map("cedente_invites")
}

/**
 * ACEITE DO TERMO
 */
model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(
    fields: [cedenteId],
    references: [id],
    onDelete: Cascade
  )

  @@index([cedenteId])
  @@map("cedente_term_acceptances")
}
