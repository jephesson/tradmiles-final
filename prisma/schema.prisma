generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // Prisma 7+: NÃO coloque url aqui se você usa prisma.config.ts
}

/**
 * =========================
 * ENUMS BÁSICOS
 * =========================
 */
enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PixTipo {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

enum SalePaymentStatus {
  PENDING
  PAID
  CANCELED
}

/**
 * =========================
 * BLOQUEIOS / PROGRAMAS
 * =========================
 */
enum LoyaltyProgram {
  LATAM
  SMILES
  LIVELO
  ESFERA
}

enum BlockStatus {
  OPEN
  UNBLOCKED
  CANCELED
}

enum CedenteCommissionStatus {
  PENDING
  PAID
  CANCELED
}

/**
 * =========================
 * ✅ CLUBES (ASSINATURAS)
 * =========================
 */
enum ClubSubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
}

/**
 * =========================
 * USERS / LOGIN / CONVITES
 * =========================
 */
model User {
  id    String @id @default(uuid())
  login String @unique
  name  String

  employeeId String? @unique

  cpf          String? @unique
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cedentes em que o usuário é o "responsável" (owner)
  cedentesOwned Cedente[] @relation("CedenteOwner")

  // Cedentes que ele revisou (aprovou/reprovou)
  cedentesReviewed Cedente[] @relation("CedenteReviewedBy")

  // Dívidas criadas por este usuário
  debtsCreated Debt[]

  // Bloqueios criados por este usuário
  blockedCreated BlockedAccount[] @relation("BlockedCreatedBy")

  // Observações de bloqueio criadas por este usuário
  blockedObsCreated BlockObservation[] @relation("BlockedObsCreatedBy")

  // Compras liberadas por este usuário
  comprasLiberadas Purchase[] @relation("CompraLiberadaPor")

  // Compras finalizadas por este usuário
  comprasFinalizadas Purchase[] @relation("PurchaseFinalizedBy")

  // Comissões de cedente (geradas / pagas)
  cedenteCommissionsGenerated CedenteCommission[] @relation("CedenteCommissionGeneratedBy")
  cedenteCommissionsPaid      CedenteCommission[] @relation("CedenteCommissionPaidBy")

  // Clientes criados por este usuário
  clientesCreated Cliente[] @relation("ClienteCreatedBy")

  // Vendas feitas por este usuário
  salesSold Sale[] @relation("SaleSeller")

  /**
   * =========================
   * RATEIO (BASE PERCENTUAL)
   * =========================
   */
  profitSharesOwned  ProfitShare[]     @relation("ProfitShareOwner")
  profitShareAsPayee ProfitShareItem[] @relation("ProfitSharePayee")

  /**
   * =========================
   * PAGAMENTOS (COMISSÕES FUNCIONÁRIOS POR DIA)
   * =========================
   */
  employeePayouts     EmployeePayout[] @relation("EmployeePayoutUser")
  employeePayoutsPaid EmployeePayout[] @relation("EmployeePayoutPaidBy")

  /**
   * =========================
   * IMPOSTOS (PAGAMENTO MENSAL)
   * =========================
   */
  taxMonthsPaid TaxMonthPayment[] @relation("TaxMonthPaidBy")

  // Um convite por usuário
  employeeInvite EmployeeInvite?

  @@index([team])
  @@index([role])
  @@map("users")
}

model EmployeeInvite {
  id     String @id @default(uuid())
  userId String @unique
  code   String @unique

  isActive   Boolean   @default(true)
  uses       Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cedentes Cedente[]

  @@index([isActive])
  @@index([userId])
  @@map("employee_invites")
}

/**
 * =========================
 * RATEIO (BASE PERCENTUAL) — VERSIONADO POR DATA
 * =========================
 */
model ProfitShare {
  id      String @id @default(cuid())
  team    String
  ownerId String

  effectiveFrom DateTime  @default(dbgenerated("'2000-01-01 00:00:00'::timestamp"))
  effectiveTo   DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User              @relation("ProfitShareOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  items ProfitShareItem[]

  @@unique([team, ownerId, effectiveFrom], map: "uniq_profitshare_owner_from")
  @@index([team])
  @@index([ownerId])
  @@index([team, ownerId, effectiveFrom])
  @@index([team, ownerId, effectiveTo])
  @@map("profit_shares")
}

model ProfitShareItem {
  id      String @id @default(cuid())
  shareId String
  payeeId String

  bps Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  share ProfitShare @relation(fields: [shareId], references: [id], onDelete: Cascade)
  payee User        @relation("ProfitSharePayee", fields: [payeeId], references: [id], onDelete: Cascade)

  @@unique([shareId, payeeId])
  @@index([payeeId])
  @@map("profit_share_items")
}

/**
 * =========================
 * CEDENTES
 * =========================
 */
model Cedente {
  id            String @id @default(uuid())
  identificador String @unique

  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String    @unique

  telefone    String?
  emailCriado String?

  banco             String
  pixTipo           PixTipo
  chavePix          String
  titularConfirmado Boolean @default(true)

  senhaEmail     String?
  senhaSmiles    String?
  senhaLatamPass String?
  senhaLivelo    String?
  senhaEsfera    String?

  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  status     CedenteStatus @default(PENDING)
  reviewedAt DateTime?

  reviewedById String?
  reviewedBy   User?   @relation("CedenteReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  ownerId String
  owner   User   @relation("CedenteOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  inviteId String?
  invite   EmployeeInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  termAcceptances CedenteTermAcceptance[]

  blockedAccounts    BlockedAccount[]
  purchases          Purchase[]
  cedenteCommissions CedenteCommission[]
  emissions          EmissionEvent[]
  sales              Sale[]

  // ✅ assinaturas de clube por cedente
  clubSubscriptions ClubSubscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([inviteId])
  @@index([createdAt])
  @@map("cedentes")
}

model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([cedenteId])
  @@index([acceptedAt])
  @@map("cedente_term_acceptances")
}

/**
 * =========================
 * ✅ CLUBES (ASSINATURAS) — FORA DA COMPRA
 * =========================
 */
model ClubSubscription {
  id String @id @default(cuid())

  // facilita query por time (derivado do owner.team, mas gravado aqui)
  team      String
  cedenteId String
  program   LoyaltyProgram

  // Ex: 10 => 10k
  tierK      Int @default(0)
  priceCents Int @default(0)

  subscribedAt DateTime
  renewalDay   Int      @default(1)

  // controle operacional
  lastRenewedAt    DateTime?
  pointsExpireAt   DateTime? // expiração dos pontos do clube/promo (pra alerta)
  renewedThisCycle Boolean                @default(false)
  status           ClubSubscriptionStatus @default(ACTIVE)

  // ✅ só smiles: quando volta a ser elegível ao bônus de assinatura (ex.: +365d)
  smilesBonusEligibleAt DateTime?

  notes String?

  // ✅ NOVO: se veio de uma compra (PurchaseItem tipo CLUB), trava duplicação
  sourcePurchaseItemId String?       @unique
  sourcePurchaseItem   PurchaseItem? @relation("ClubSubFromPurchaseItem", fields: [sourcePurchaseItemId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([team, program])
  @@index([team, status])
  @@index([cedenteId])
  @@index([pointsExpireAt])
  @@map("club_subscriptions")
}

/**
 * =========================
 * SNAPSHOT (CAIXA + TOTAIS)
 * =========================
 */
model CashSnapshot {
  id   String   @id @default(cuid())
  date DateTime @unique

  cashCents Int @default(0)

  totalBruto   Int
  totalDividas Int
  totalLiquido Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@map("cash_snapshots")
}

model Settings {
  id  String @id @default(cuid())
  key String @unique

  latamRateCents  Int @default(2000)
  smilesRateCents Int @default(1800)
  liveloRateCents Int @default(2200)
  esferaRateCents Int @default(1700)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

/**
 * =========================
 * DÍVIDAS
 * =========================
 */
enum DebtStatus {
  OPEN
  PAID
  CANCELED
}

model Debt {
  id          String     @id @default(cuid())
  title       String
  description String?
  totalCents  Int
  status      DebtStatus @default(OPEN)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  payments DebtPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("debts")
}

model DebtPayment {
  id          String   @id @default(cuid())
  debtId      String
  amountCents Int
  note        String?
  paidAt      DateTime @default(now())

  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([debtId])
  @@index([paidAt])
  @@map("debt_payments")
}

/**
 * =========================
 * BLOQUEIOS
 * =========================
 */
model BlockedAccount {
  id String @id @default(cuid())

  cedenteId String
  program   LoyaltyProgram
  status    BlockStatus    @default(OPEN)

  note              String?
  estimatedUnlockAt DateTime?

  createdById String?
  createdBy   User?   @relation("BlockedCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  resolvedAt   DateTime?
  observations BlockObservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@unique([cedenteId, program, status], map: "uniq_open_block_per_program")
  @@index([cedenteId])
  @@index([program])
  @@index([status])
  @@index([createdAt])
  @@map("blocked_accounts")
}

model BlockObservation {
  id        String @id @default(cuid())
  blockedId String
  text      String

  createdById String?
  createdBy   User?   @relation("BlockedObsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blocked BlockedAccount @relation(fields: [blockedId], references: [id], onDelete: Cascade)

  @@index([blockedId])
  @@index([createdAt])
  @@map("block_observations")
}

/**
 * =========================
 * COMPRAS
 * =========================
 */
enum PurchaseStatus {
  OPEN
  CLOSED
  CANCELED
}

enum PurchaseItemType {
  CLUB
  POINTS_BUY
  TRANSFER
  ADJUSTMENT
  EXTRA_COST
}

enum PurchaseItemStatus {
  PENDING
  RELEASED
  CANCELED
}

enum TransferMode {
  FULL_POINTS
  POINTS_PLUS_CASH
}

model Purchase {
  id        String         @id @default(cuid())
  numero    String         @unique
  cedenteId String
  status    PurchaseStatus @default(OPEN)

  ciaAerea       LoyaltyProgram?
  pontosCiaTotal Int             @default(0)

  cedentePayCents     Int @default(0)
  vendorCommissionBps Int @default(100)

  subtotalCents Int @default(0)
  comissaoCents Int @default(0)
  totalCents    Int @default(0)

  custoMilheiroCents Int @default(0)
  metaMarkupCents    Int @default(150)
  metaMilheiroCents  Int @default(0)

  saldoPrevistoLatam  Int?
  saldoPrevistoSmiles Int?
  saldoPrevistoLivelo Int?
  saldoPrevistoEsfera Int?

  saldoAplicadoLatam  Int?
  saldoAplicadoSmiles Int?
  saldoAplicadoLivelo Int?
  saldoAplicadoEsfera Int?

  liberadoEm    DateTime?
  liberadoPorId String?
  liberadoPor   User?     @relation("CompraLiberadaPor", fields: [liberadoPorId], references: [id], onDelete: SetNull)

  finalizedAt   DateTime?
  finalizedById String?
  finalizedBy   User?     @relation("PurchaseFinalizedBy", fields: [finalizedById], references: [id], onDelete: SetNull)

  finalSalesCents            Int?
  finalSalesPointsValueCents Int?
  finalSalesTaxesCents       Int?

  finalProfitBrutoCents Int?
  finalBonusCents       Int?
  finalProfitCents      Int?

  finalSoldPoints       Int?
  finalPax              Int?
  finalAvgMilheiroCents Int?
  finalRemainingPoints  Int?

  observacao String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cedente Cedente        @relation(fields: [cedenteId], references: [id], onDelete: Cascade)
  items   PurchaseItem[]
  sales   Sale[]

  cedenteCommission CedenteCommission? @relation("PurchaseCedenteCommission")

  @@index([cedenteId])
  @@index([status])
  @@index([ciaAerea])
  @@index([finalizedAt])
  @@index([finalizedById])
  @@map("purchases")
}

model PurchaseItem {
  id         String             @id @default(cuid())
  purchaseId String
  type       PurchaseItemType
  status     PurchaseItemStatus @default(PENDING)

  programFrom LoyaltyProgram?
  programTo   LoyaltyProgram?

  pointsBase  Int     @default(0)
  bonusMode   String?
  bonusValue  Int?
  pointsFinal Int     @default(0)

  amountCents  Int           @default(0)
  transferMode TransferMode?

  pointsDebitedFromOrigin Int @default(0)

  title   String
  details String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  // ✅ NOVO: 1 item CLUB pode gerar 1 ClubSubscription
  clubSubscription ClubSubscription? @relation("ClubSubFromPurchaseItem")

  @@index([purchaseId])
  @@index([type])
  @@index([status])
  @@map("purchase_items")
}

model Counter {
  key   String @id
  value Int    @default(0)

  updatedAt DateTime @updatedAt

  @@map("counters")
}

/**
 * =========================
 * COMISSÃO DO CEDENTE
 * =========================
 */
model CedenteCommission {
  id String @id @default(cuid())

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  purchaseId String?   @unique
  purchase   Purchase? @relation("PurchaseCedenteCommission", fields: [purchaseId], references: [id], onDelete: SetNull)

  amountCents Int
  status      CedenteCommissionStatus @default(PENDING)

  generatedAt   DateTime @default(now())
  generatedById String?
  generatedBy   User?    @relation("CedenteCommissionGeneratedBy", fields: [generatedById], references: [id], onDelete: SetNull)

  paidAt   DateTime?
  paidById String?
  paidBy   User?     @relation("CedenteCommissionPaidBy", fields: [paidById], references: [id], onDelete: SetNull)

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cedenteId, status, generatedAt])
  @@index([paidAt])
  @@map("cedente_commissions")
}

/**
 * =========================
 * CLIENTES
 * =========================
 */
enum ClienteTipo {
  PESSOA
  EMPRESA
}

enum ClienteOrigem {
  BALCAO_MILHAS
  PARTICULAR
  SITE
  OUTROS
}

model Cliente {
  id            String @id @default(cuid())
  identificador String @unique

  tipo ClienteTipo @default(PESSOA)
  nome String

  cpfCnpj  String?
  telefone String?

  origem          ClienteOrigem
  origemDescricao String?

  createdById String?
  createdBy   User?   @relation("ClienteCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  sales Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([origem])
  @@index([createdAt])
  @@map("clientes")
}

/**
 * =========================
 * RECEBÍVEIS
 * =========================
 */
enum ReceivableStatus {
  OPEN
  RECEIVED
  CANCELED
}

model Receivable {
  id            String           @id @default(cuid())
  title         String
  description   String?
  totalCents    Int
  receivedCents Int              @default(0)
  balanceCents  Int
  status        ReceivableStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  receipts Receipt[]
  sale     Sale?     @relation("SaleReceivable")

  @@index([status])
  @@index([createdAt])
  @@map("receivables")
}

model Receipt {
  id           String     @id @default(cuid())
  receivableId String
  receivable   Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  amountCents Int
  note        String?
  receivedAt  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([receivableId])
  @@index([receivedAt])
  @@map("Receipt") // ⚠️ se sua tabela for lowercase, troque pra "receipts"
}

/**
 * =========================
 * CONTAGEM CPF (EMISSÕES)
 * =========================
 */
enum EmissionSource {
  SALE
  MANUAL
  ADJUSTMENT
}

model EmissionEvent {
  id String @id @default(cuid())

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  program         LoyaltyProgram
  passengersCount Int            @default(1)

  issuedAt DateTime
  source   EmissionSource @default(SALE)

  note String?

  createdAt DateTime @default(now())

  @@index([cedenteId, program, issuedAt])
  @@index([program, issuedAt])
  @@map("emission_events")
}

/**
 * =========================
 * VENDAS
 * =========================
 */
model Sale {
  id     String @id @default(cuid())
  numero String @unique

  date DateTime

  program    LoyaltyProgram
  points     Int
  passengers Int

  milheiroCents Int

  embarqueFeeCents Int @default(0)
  pointsValueCents Int @default(0)
  totalCents       Int @default(0)

  commissionCents Int @default(0)
  bonusCents      Int @default(0)

  metaMilheiroCents Int @default(0)

  feeCardLabel String?
  locator      String?

  paymentStatus SalePaymentStatus @default(PENDING)
  paidAt        DateTime?

  cedenteId String
  cedente   Cedente @relation(fields: [cedenteId], references: [id], onDelete: Restrict)

  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Restrict)

  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id], onDelete: SetNull)

  sellerId String?
  seller   User?   @relation("SaleSeller", fields: [sellerId], references: [id], onDelete: SetNull)

  receivableId String?     @unique
  receivable   Receivable? @relation("SaleReceivable", fields: [receivableId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([program, date])
  @@index([paymentStatus])
  @@index([cedenteId])
  @@index([clienteId])
  @@index([purchaseId])
  @@map("sales")
}

/**
 * =========================
 * PAGAMENTOS (COMISSÕES FUNCIONÁRIOS POR DIA)
 * =========================
 * ✅ Agora:
 * - date vira String "YYYY-MM-DD" (sem dor de timezone)
 * - team fica gravado no payout (query simples e rápida)
 * - paidAt é NULL quando pendente (só preenche ao pagar)
 */
model EmployeePayout {
  id String @id @default(cuid())

  team   String
  date   String // "YYYY-MM-DD"
  userId String

  grossProfitCents Int @default(0)
  tax7Cents        Int @default(0)
  feeCents         Int @default(0)
  netPayCents      Int @default(0)

  breakdown Json?

  paidAt   DateTime?
  paidById String?

  user   User  @relation("EmployeePayoutUser", fields: [userId], references: [id], onDelete: Cascade)
  paidBy User? @relation("EmployeePayoutPaidBy", fields: [paidById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([team, date, userId], map: "uniq_employee_payout_team_day_user")
  @@index([team, date])
  @@index([userId, date])
  @@map("employee_payouts")
}

/**
 * =========================
 * IMPOSTOS (FECHAMENTO / PAGAMENTO MENSAL)
 * =========================
 * - month: "YYYY-MM"
 * - totalTaxCents: snapshot do total de imposto do mês quando marcou como pago
 * - breakdown: snapshot por usuário (ex.: [{ userId, taxCents }...])
 */
model TaxMonthPayment {
  id String @id @default(cuid())

  team  String
  month String // "YYYY-MM"

  totalTaxCents Int   @default(0)
  breakdown     Json?

  paidAt   DateTime?
  paidById String?
  paidBy   User?     @relation("TaxMonthPaidBy", fields: [paidById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([team, month], map: "uniq_tax_month_payment_team_month")
  @@index([team, month])
  @@index([paidAt])
  @@map("tax_month_payments")
}

model CaixaImediatoSnapshot {
  id              String   @id @default(cuid())
  team            String
  date            String   // YYYY-MM-DD (mais fácil p/ upsert e lista)
  cashCents        Int     @default(0)
  totalBrutoCents  Int     @default(0)
  totalDividasCents Int    @default(0)
  totalLiquidoCents Int    @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([team, date])
  @@index([team, date])
}
