generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // Prisma 7+: NÃO coloque url aqui se você usa prisma.config.ts
}

enum CedenteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PixTipo {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

model User {
  id    String @id @default(uuid())
  login String @unique
  name  String

  employeeId String? @unique

  cpf          String? @unique
  email        String? @unique
  team         String
  role         String
  passwordHash String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cedentes em que o usuário é o "responsável" (owner)
  cedentesOwned Cedente[] @relation("CedenteOwner")

  // Cedentes que ele revisou (aprovou/reprovou)
  cedentesReviewed Cedente[] @relation("CedenteReviewedBy")

  // Um convite por usuário (no teu fluxo)
  employeeInvite EmployeeInvite?

  @@index([team])
  @@index([role])
  @@map("users")
}

model EmployeeInvite {
  id     String @id @default(uuid())
  userId String @unique
  code   String @unique

  isActive   Boolean   @default(true)
  uses       Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cedentes Cedente[]

  @@index([isActive])
  @@index([userId])
  @@map("employee_invites")
}

model Cedente {
  id            String @id @default(uuid())
  identificador String @unique

  nomeCompleto   String
  dataNascimento DateTime?
  cpf            String @unique

  telefone    String?
  emailCriado String?

  banco             String
  pixTipo           PixTipo
  chavePix          String
  titularConfirmado Boolean @default(true)

  senhaEmail     String?
  senhaSmiles    String?
  senhaLatamPass String?
  senhaLivelo    String?
  senhaEsfera    String?

  pontosLatam  Int @default(0)
  pontosSmiles Int @default(0)
  pontosLivelo Int @default(0)
  pontosEsfera Int @default(0)

  status     CedenteStatus @default(PENDING)
  reviewedAt DateTime?

  reviewedById String?
  reviewedBy   User? @relation("CedenteReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  ownerId String
  owner   User @relation("CedenteOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  inviteId String?
  invite   EmployeeInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  termAcceptances CedenteTermAcceptance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([inviteId])
  @@index([createdAt])
  @@map("cedentes")
}

model CedenteTermAcceptance {
  id          String   @id @default(uuid())
  cedenteId   String
  termoVersao String
  ip          String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  cedente Cedente @relation(fields: [cedenteId], references: [id], onDelete: Cascade)

  @@index([cedenteId])
  @@index([acceptedAt])
  @@map("cedente_term_acceptances")
}

model CashSnapshot {
  id        String   @id @default(cuid())
  date      DateTime @unique // salva “o dia” (00:00) em UTC ou normalizado
  cashCents Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

